<?php header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0"); header("Expires: 0"); $origin = $_SERVER['HTTP_ORIGIN'] ?? ''; $allowedOrigins = [ "http://localhost:3000", "https://mediumblue-parrot-101649.hostingersite.com", "https://sandybrown-wolf-795340.hostingersite.com", "srv920549.hstgr.cloud", "https://miaventura.shop/bono50.html", "https://deeppink-butterfly-623902.hostingersite.com", "https://gestoradmin.store", "https://www.gestoradmin.store", ]; if (in_array($origin, $allowedOrigins, true)) { // Permitir solicitudes solo desde los orígenes definidos header("Access-Control-Allow-Origin: $origin"); header("Vary: Origin"); } header("Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS"); header("Access-Control-Allow-Headers: Content-Type, Authorization"); header("Access-Control-Allow-Credentials: true"); // Permite el envío de cookies y credenciales header('Content-Type: application/json; charset=utf-8'); if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { http_response_code(200); exit(); } require_once 'conexion.php'; date_default_timezone_set('America/Argentina/Buenos_Aires'); $metodo = $_SERVER['REQUEST_METHOD']; $recurso = $_GET['recurso'] ?? ''; $id = isset($_GET['id']) ? intval($_GET['id']) : null; /** ===== Helpers ===== */ function getInput() { $raw = file_get_contents("php://input"); $input = json_decode($raw, true); if (!is_array($input)) $input = $_POST ?: []; return $input; } function getClientIp(): string { if (!empty($_SERVER['HTTP_CF_CONNECTING_IP'])) return $_SERVER['HTTP_CF_CONNECTING_IP']; if (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) { $parts = array_map('trim', explode(',', $_SERVER['HTTP_X_FORWARDED_FOR'])); if (filter_var($parts[0], FILTER_VALIDATE_IP)) return $parts[0]; } return $_SERVER['REMOTE_ADDR'] ?? '0.0.0.0'; } function getFbclidFromReferer(): string { $ref = $_SERVER['HTTP_REFERER'] ?? ''; if (!$ref) return ''; $u = parse_url($ref); if (empty($u['query'])) return ''; parse_str($u['query'], $q); return isset($q['fbclid']) ? (string)$q['fbclid'] : ''; } /** ===== CRUD genérico ===== */ function crudGenerico($conexion, $tabla, $metodo, $id) { $input = getInput(); switch ($metodo) { case 'GET': if ($id) { $stmt = $conexion->prepare("SELECT * FROM $tabla WHERE id = ?"); $stmt->bind_param("i", $id); } elseif (isset($_GET['codigo'])) { $codigo = strtolower(trim($_GET['codigo'])); $stmt = $conexion->prepare("SELECT * FROM $tabla WHERE LOWER(code_hex) = ?"); $stmt->bind_param("s", $codigo); } else { $stmt = $conexion->prepare("SELECT * FROM $tabla ORDER BY created_at DESC"); } $stmt->execute(); $res = $stmt->get_result(); echo json_encode($res->fetch_all(MYSQLI_ASSOC)); break; case 'POST': if ($tabla === 'lead') { // 1) VALIDAR code_hex EXACTO (no generar ni corregir) $code_hex_in = isset($input['code_hex']) ? (string)$input['code_hex'] : ''; if (!preg_match('/^[0-9a-fA-F]{4}$/', $code_hex_in)) { http_response_code(422); echo json_encode([ "ok" => false, "error" => "code_hex inválido o ausente (debe ser 4 dígitos hex).", "code_hex_recibido" => $code_hex_in ]); exit; } $code_hex = strtolower($code_hex_in); $user_agent = isset($input['user_agent']) ? trim($input['user_agent']) : ($_SERVER['HTTP_USER_AGENT'] ?? ''); $external_id = isset($input['external_id']) ? trim($input['external_id']) : ''; $fbc = isset($input['fbc']) ? trim($input['fbc']) : ''; $fbclid = isset($input['fbclid']) ? trim($input['fbclid']) : ''; if ($fbclid === '') $fbclid = getFbclidFromReferer(); $ipFront = isset($input['ip']) ? trim($input['ip']) : ''; $enviado = isset($input['enviado']) ? (int)$input['enviado'] : 0; $created_at = isset($input['created_at']) ? trim($input['created_at']) : date("Y-m-d H:i:s"); // 2) IP preferida: detectada por server $ipDetected = getClientIp(); $ip = filter_var($ipDetected, FILTER_VALIDATE_IP) ? $ipDetected : (filter_var($ipFront, FILTER_VALIDATE_IP) ? $ipFront : '0.0.0.0'); // 3) Escapar y guardar $user_agent = $conexion->real_escape_string($user_agent); $external_id = $conexion->real_escape_string($external_id); $fbc = $conexion->real_escape_string($fbc); $fbclid = $conexion->real_escape_string($fbclid); $ip = $conexion->real_escape_string($ip); $code_hex = $conexion->real_escape_string($code_hex); $created_at = $conexion->real_escape_string($created_at); $stmt = $conexion->prepare( "INSERT INTO $tabla (user_agent, external_id, fbc, fbclid, ip, code_hex, enviado, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)" ); $stmt->bind_param("ssssssis", $user_agent, $external_id, $fbc, $fbclid, $ip, $code_hex, $enviado, $created_at); $ok = $stmt->execute(); if ($ok && $stmt->affected_rows > 0) { echo json_encode(["ok" => true, "message" => "Lead creado correctamente", "code_hex_recibido" => $code_hex]); } else { http_response_code(500); echo json_encode(["ok" => false, "error" => "No se pudo crear el registro"]); } } else { // pageview $user_agent = isset($input['user_agent']) ? trim($input['user_agent']) : ($_SERVER['HTTP_USER_AGENT'] ?? ''); $external_id = isset($input['external_id']) ? trim($input['external_id']) : ''; $fbc = isset($input['fbc']) ? trim($input['fbc']) : ''; $fbclid = isset($input['fbclid']) ? trim($input['fbclid']) : ''; if ($fbclid === '') $fbclid = getFbclidFromReferer(); $created_at = isset($input['created_at']) ? trim($input['created_at']) : date("Y-m-d H:i:s"); $user_agent = $conexion->real_escape_string($user_agent); $external_id = $conexion->real_escape_string($external_id); $fbc = $conexion->real_escape_string($fbc); $fbclid = $conexion->real_escape_string($fbclid); $created_at = $conexion->real_escape_string($created_at); $stmt = $conexion->prepare( "INSERT INTO $tabla (user_agent, external_id, fbc, fbclid, created_at) VALUES (?, ?, ?, ?, ?)" ); $stmt->bind_param("sssss", $user_agent, $external_id, $fbc, $fbclid, $created_at); $ok = $stmt->execute(); if ($ok && $stmt->affected_rows > 0) echo json_encode(["ok" => true, "message" => "Pageview creado correctamente"]); else { http_response_code(500); echo json_encode(["ok" => false, "error" => "No se pudo crear el registro"]); } } break; case 'PUT': if (!$id) { http_response_code(400); echo json_encode(["error"=>"ID requerido"]); exit; } if (!$input){ http_response_code(400); echo json_encode(["error"=>"Datos no enviados"]); exit; } // Si se pretende cambiar code_hex, validar 4 dígitos hex if (isset($input['code_hex'])) { if (!preg_match('/^[0-9a-fA-F]{4}$/', (string)$input['code_hex'])) { unset($input['code_hex']); // no actualizamos si es inválido } else { $input['code_hex'] = strtolower($input['code_hex']); } } $campos = []; $valores = []; $tipos = ""; foreach (['user_agent','external_id','fbc','fbclid','ip','code_hex','created_at','enviado'] as $campo) { if (array_key_exists($campo, $input)) { $campos[] = "$campo = ?"; $valores[] = ($campo === 'enviado') ? ((int)$input[$campo] ? 1 : 0) : trim((string)$input[$campo]); $tipos .= ($campo === 'enviado') ? "i" : "s"; } } if (empty($campos)) { http_response_code(400); echo json_encode(["error"=>"No hay campos para actualizar"]); exit; } $sql = "UPDATE $tabla SET ".implode(", ", $campos)." WHERE id = ?"; $valores[] = $id; $tipos .= "i"; $stmt = $conexion->prepare($sql); $stmt->bind_param($tipos, ...$valores); $stmt->execute(); echo json_encode(["message" => ($stmt->affected_rows > 0) ? ucfirst($tabla)." actualizado correctamente" : "No hubo cambios"]); break; case 'DELETE': if (!$id) { http_response_code(400); echo json_encode(["error"=>"ID requerido"]); exit; } $stmt = $conexion->prepare("DELETE FROM $tabla WHERE id = ?"); $stmt->bind_param("i", $id); $stmt->execute(); if ($stmt->affected_rows > 0) echo json_encode(["message" => ucfirst($tabla)." eliminado correctamente"]); else { http_response_code(500); echo json_encode(["error" => "No se pudo eliminar"]); } break; default: http_response_code(405); echo json_encode(["error" => "Método no permitido"]); } } if ($recurso === 'pageview') { crudGenerico($conexion, 'pageview', $metodo, $id); } elseif ($recurso === 'lead') { crudGenerico($conexion, 'lead', $metodo, $id); } else { http_response_code(400); echo json_encode(["error" => "recurso inválido"]); }